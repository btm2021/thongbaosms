<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Notification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', 'Tahoma', sans-serif;
            background: #c0c0c0;
            color: #000000;
            padding: 0;
            font-size: 11px;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .title-bar {
            background: linear-gradient(to bottom, #0a246a 0%, #a6caf0 3%, #0a246a 100%);
            color: white;
            padding: 3px 8px;
            font-weight: bold;
            font-size: 11px;
            border-bottom: 1px solid #808080;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-app-region: drag;
        }

        .window-controls {
            display: flex;
            gap: 2px;
            -webkit-app-region: no-drag;
        }

        .window-control-btn {
            width: 16px;
            height: 14px;
            border: 1px outset #c0c0c0;
            background: #c0c0c0;
            color: #000000;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .window-control-btn:hover {
            background: #e0e0e0;
        }

        .window-control-btn:active {
            border: 1px inset #c0c0c0;
        }

        .menu-bar {
            background: #c0c0c0;
            border-bottom: 1px solid #808080;
            padding: 2px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .menu-left {
            display: flex;
            align-items: center;
        }

        .menu-item {
            display: inline-block;
            padding: 4px 8px;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
        }

        .menu-item:hover {
            border: 1px outset #c0c0c0;
            background: #e0e0e0;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            min-width: 150px;
            z-index: 1000;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            padding: 4px 8px;
            cursor: pointer;
            border: 1px solid transparent;
            font-size: 11px;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background: #e0e0e0;
            border: 1px inset #c0c0c0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid #404040;
        }

        .status-dot.connected {
            background: #00ff00;
        }

        .status-dot.disconnected {
            background: #ff0000;
        }

        .content-area {
            flex: 1;
            padding: 8px;
            background: #c0c0c0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .group-box {
            border: 2px inset #c0c0c0;
            background: #c0c0c0;
            flex-shrink: 0;
        }

        .group-box-title {
            background: #c0c0c0;
            padding: 2px 8px;
            font-weight: bold;
            font-size: 11px;
            color: #000080;
            border-bottom: 1px solid #808080;
        }

        .group-box-content {
            padding: 12px;
        }

        .config-row {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-layout {
            display: flex;
            gap: 16px;
        }

        .config-column {
            flex: 1;
        }

        .config-column-title {
            font-weight: bold;
            font-size: 10px;
            color: #000080;
            margin-bottom: 8px;
            padding-bottom: 2px;
            border-bottom: 1px solid #808080;
        }

        .config-row label {
            min-width: 140px;
            font-size: 11px;
            color: #000000;
        }

        .config-row input[type="text"],
        .config-row input[type="number"],
        .config-row input[type="password"],
        .config-row select,
        .config-row textarea {
            flex: 1;
            padding: 2px 4px;
            border: 2px inset #c0c0c0;
            background: #ffffff;
            font-size: 11px;
            font-family: 'MS Sans Serif', 'Tahoma', sans-serif;
        }

        .config-row input[type="text"]:focus,
        .config-row input[type="number"]:focus,
        .config-row input[type="password"]:focus,
        .config-row select:focus,
        .config-row textarea:focus {
            outline: none;
            border: 2px inset #0000ff;
        }

        .config-row input[type="checkbox"] {
            margin-right: 4px;
        }

        .transaction-history {
            max-height: 200px;
            overflow-y: auto;
            border: 2px inset #c0c0c0;
            background: #ffffff;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            font-family: 'MS Sans Serif', 'Tahoma', sans-serif;
        }

        .transaction-table th {
            background: #c0c0c0;
            border: 1px solid #808080;
            padding: 4px 6px;
            text-align: left;
            font-weight: bold;
            font-size: 10px;
            color: #000080;
        }

        .transaction-table td {
            border: 1px solid #c0c0c0;
            padding: 4px 6px;
            vertical-align: top;
        }

        .transaction-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .transaction-table tr:hover {
            background: #e0e0e0;
        }

        .transaction-time {
            font-size: 10px;
            white-space: nowrap;
        }

        .transaction-bank {
            font-weight: bold;
            color: #000080;
            font-size: 10px;
            text-transform: uppercase;
        }

        .transaction-amount {
            font-weight: bold;
            text-align: right;
            white-space: nowrap;
        }

        .transaction-amount.incoming {
            color: #008000;
        }

        .transaction-amount.outgoing {
            color: #800000;
        }

        .transaction-balance {
            font-weight: bold;
            text-align: right;
            white-space: nowrap;
            color: #000080;
        }

        .balance-summary {
            margin-bottom: 12px;
            border: 2px inset #c0c0c0;
            background: #ffffff;
            padding: 8px;
        }

        .balance-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            font-family: 'MS Sans Serif', 'Tahoma', sans-serif;
        }

        .balance-table td {
            padding: 4px 8px;
            border: none;
        }

        .balance-table td:first-child {
            font-weight: bold;
            color: #000080;
            width: 120px;
        }

        .balance-amount {
            text-align: right;
            font-weight: bold;
            color: #008000;
        }

        .total-row {
            border-top: 1px solid #808080;
            margin-top: 4px;
        }

        .total-row td {
            padding-top: 8px;
        }

        .total-amount {
            color: #000080;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }

        .message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Scrollbar styling for Windows classic look */
        ::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }

        ::-webkit-scrollbar-track {
            background: #c0c0c0;
            border: 1px inset #c0c0c0;
        }

        ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #e0e0e0;
        }

        ::-webkit-scrollbar-corner {
            background: #c0c0c0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="title-bar">
            <span>SMS Notification - Configuration Panel</span>
            <div class="window-controls">
                <button class="window-control-btn" onclick="closeWindow()">√ó</button>
            </div>
        </div>

        <div class="menu-bar">
            <div class="menu-left">
                <div class="menu-item" onclick="toggleDropdown('toolsMenu')">
                    Tools
                    <div id="toolsMenu" class="dropdown-menu">
                        <div class="dropdown-item" onclick="startServices()">Start Services</div>
                        <div class="dropdown-item" onclick="stopServices()">Stop Services</div>
                        <div class="dropdown-item" onclick="updateConfig()">Save Configuration</div>
                        <div class="dropdown-item" onclick="loadConfig()">Refresh Configuration</div>
                    </div>
                </div>
                <div class="menu-item" onclick="toggleDropdown('testMenu')">
                    Test
                    <div id="testMenu" class="dropdown-menu">
                        <div class="dropdown-item" onclick="testPushbulletConnection()">Test Pushbullet</div>
                        <div class="dropdown-item" onclick="testSupabaseConnection()">Test Supabase</div>
                        <div class="dropdown-item" onclick="testVietcombankSMS()">Test Vietcombank</div>
                        <div class="dropdown-item" onclick="testViettinSMS()">Test VietinBank</div>
                        <div class="dropdown-item" onclick="testMultiplePopups()">Test Multi Popup</div>
                        <div class="dropdown-item" onclick="closeAllPopups()">Close All Popups</div>
                        <div class="dropdown-item" onclick="testCustomPopup()">Custom Popup Test</div>
                    </div>
                </div>
                <div class="menu-item" onclick="toggleDropdown('historyMenu')">
                    History
                    <div id="historyMenu" class="dropdown-menu">
                        <div class="dropdown-item" onclick="loadTransactionHistory()">Refresh History</div>
                        <div class="dropdown-item" onclick="clearTransactionHistory()">Clear Display</div>
                    </div>
                </div>
            </div>
            <div class="status-indicator">
                <span class="status-dot disconnected" id="statusDot"></span>
                <span id="statusText">Disconnected</span>
            </div>
        </div>

        <div class="content-area">
            <div class="group-box">
                <div class="group-box-title">Connection Settings</div>
                <div class="group-box-content">
                    <div
                        style="background: #ffffff; padding: 6px; margin-bottom: 8px; border: 1px inset #c0c0c0; font-size: 10px;">
                        Config Path: <span id="configPath" style="font-weight: bold;">Loading...</span>
                    </div>

                    <div class="config-row">
                        <label for="pushbulletApi">Pushbullet API Key:</label>
                        <input type="text" id="pushbulletApi" placeholder="Enter Pushbullet API key">
                    </div>

                    <div class="config-row">
                        <label for="supabaseUrl">Supabase URL:</label>
                        <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
                    </div>

                    <div class="config-row">
                        <label for="supabaseKey">Supabase Key:</label>
                        <input type="text" id="supabaseKey" placeholder="Enter Supabase anon key">
                    </div>
                </div>
            </div>

            <div class="group-box">
                <div class="group-box-title">Display Settings</div>
                <div class="group-box-content">
                    <div class="config-layout">
                        <div class="config-column">
                            <div class="config-column-title">Popup Configuration</div>

                            <div class="config-row">
                                <label>Position:</label>
                                <select id="position">
                                    <option value="top-right">Top Right</option>
                                    <option value="top-left">Top Left</option>
                                    <option value="bottom-right">Bottom Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                </select>
                            </div>

                            <div class="config-row">
                                <label>Max Popups:</label>
                                <input type="number" id="maxPopups" value="4" min="1" max="8">
                            </div>

                            <div class="config-row">
                                <label>Auto Close (sec):</label>
                                <input type="number" id="autoCloseDelay" value="8" min="0" max="30">
                            </div>
                        </div>

                        <div class="config-column">
                            <div class="config-column-title">Options</div>

                            <div class="config-row">
                                <label>
                                    <input type="checkbox" id="soundEnabled">
                                    Enable Sound
                                </label>
                            </div>

                            <div class="config-row">
                                <label>
                                    <input type="checkbox" id="supabaseEnabled">
                                    Save to Supabase
                                </label>
                            </div>

                            <div class="config-row">
                                <label>
                                    <input type="checkbox" id="hideTransactionDetails">
                                    Hide Details
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="group-box">
                <div class="group-box-title">Transaction History</div>
                <div class="group-box-content">
                    <!-- Balance Summary Table -->
                    <div id="balanceSummary" class="balance-summary" style="display: none;">
                        <table class="balance-table">
                            <tr>
                                <td>Vietcombank:</td>
                                <td id="vietcombankBalance" class="balance-amount">0 VND</td>
                            </tr>
                            <tr>
                                <td>VietinBank:</td>
                                <td id="vietinBalance" class="balance-amount">0 VND</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>T·ªïng ti·ªÅn:</strong></td>
                                <td id="totalBalance" class="balance-amount total-amount"><strong>0 VND</strong></td>
                            </tr>
                        </table>
                    </div>

                    <div id="transactionHistory" class="transaction-history">
                        <div class="loading">Loading transaction history...</div>
                    </div>
                </div>
            </div>

            <div id="message" class="message"></div>
        </div>
    </div>

    <script src="scripts/supabase-js@2.js"></script>
    <script>
        const { ipcRenderer } = require('electron');

        let currentConfig = {};
        let supabaseClient = null;

        // Load config on startup
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await Promise.all([
                    loadConfig(),
                    loadConfigPath(),
                    updateStatus()
                ]);

                // Always try to load transactions if Supabase is configured (regardless of enabled status)
                // This ensures the transaction history is always available in the interface
                if (currentConfig.supabase?.url && currentConfig.supabase?.key) {
                    await loadTransactions();
                } else {
                    // Show message if Supabase is not configured
                    const listEl = document.getElementById('transactionHistory');
                    if (listEl) {
                        listEl.innerHTML = '<div class="no-data">‚öôÔ∏è C·∫ßn c·∫•u h√¨nh Supabase ƒë·ªÉ xem l·ªãch s·ª≠ giao d·ªãch</div>';
                    }
                    // Hide balance summary when no Supabase config
                    const balanceSummaryEl = document.getElementById('balanceSummary');
                    if (balanceSummaryEl) balanceSummaryEl.style.display = 'none';
                }
            } catch (error) {
                showMessage('‚ùå L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng: ' + error.message, 'error');
            }
        });

        async function loadConfigPath() {
            try {
                const configPath = await ipcRenderer.invoke('get-config-path');
                const configPathEl = document.getElementById('configPath');
                if (configPathEl) {
                    configPathEl.textContent = configPath;
                }
            } catch (error) {
                const configPathEl = document.getElementById('configPath');
                if (configPathEl) {
                    configPathEl.textContent = 'L·ªói t·∫£i ƒë∆∞·ªùng d·∫´n';
                }
            }
        }

        async function loadConfig() {
            currentConfig = await ipcRenderer.invoke('get-config');

            // Load API keys - with null checks
            const pushbulletApiEl = document.getElementById('pushbulletApi');
            const supabaseUrlEl = document.getElementById('supabaseUrl');
            const supabaseKeyEl = document.getElementById('supabaseKey');

            if (pushbulletApiEl) pushbulletApiEl.value = currentConfig.pushbullet?.apiKey || '';
            if (supabaseUrlEl) supabaseUrlEl.value = currentConfig.supabase?.url || '';
            if (supabaseKeyEl) supabaseKeyEl.value = currentConfig.supabase?.key || '';

            // Load display settings - with null checks
            const positionEl = document.getElementById('position');
            const soundEnabledEl = document.getElementById('soundEnabled');
            const supabaseEnabledEl = document.getElementById('supabaseEnabled');
            const maxPopupsEl = document.getElementById('maxPopups');
            const autoCloseDelayEl = document.getElementById('autoCloseDelay');
            const hideTransactionDetailsEl = document.getElementById('hideTransactionDetails');

            if (positionEl) positionEl.value = currentConfig.popup?.position || 'top-right';
            if (soundEnabledEl) soundEnabledEl.checked = currentConfig.popup?.soundEnabled !== false;
            if (supabaseEnabledEl) supabaseEnabledEl.checked = currentConfig.supabase?.enabled === true;
            if (maxPopupsEl) maxPopupsEl.value = currentConfig.popup?.maxPopups || 4;
            if (autoCloseDelayEl) autoCloseDelayEl.value = (currentConfig.popup?.autoCloseDelay || 8000) / 1000;
            if (hideTransactionDetailsEl) hideTransactionDetailsEl.checked = currentConfig.popup?.hideTransactionDetails === true;

            // Initialize Supabase client
            initializeSupabase();
        }

        function initializeSupabase() {
            if (currentConfig.supabase?.url && currentConfig.supabase?.key) {
                try {
                    supabaseClient = supabase.createClient(
                        currentConfig.supabase.url,
                        currentConfig.supabase.key
                    );
                    console.log('Supabase client initialized');
                } catch (error) {
                    console.error('Failed to initialize Supabase client:', error);
                    supabaseClient = null;
                }
            } else {
                supabaseClient = null;
            }
        }

        async function updateStatus() {
            const status = await ipcRenderer.invoke('get-status');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (statusDot && statusText) {
                if (status.connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Connected';
                } else {
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'Disconnected';
                }
            }
        }

        async function updateConfig() {
            try {
                showMessage('üîÑ ƒêang l∆∞u c·∫•u h√¨nh...', 'info');

                // Get form values with null checks
                const autoCloseDelayEl = document.getElementById('autoCloseDelay');
                const pushbulletApiEl = document.getElementById('pushbulletApi');
                const positionEl = document.getElementById('position');
                const soundEnabledEl = document.getElementById('soundEnabled');
                const maxPopupsEl = document.getElementById('maxPopups');
                const hideTransactionDetailsEl = document.getElementById('hideTransactionDetails');
                const supabaseUrlEl = document.getElementById('supabaseUrl');
                const supabaseKeyEl = document.getElementById('supabaseKey');
                const supabaseEnabledEl = document.getElementById('supabaseEnabled');

                const autoCloseSeconds = Math.max(0, Math.min(30, parseInt(autoCloseDelayEl?.value) || 8));
                const newConfig = {
                    pushbullet: {
                        apiKey: pushbulletApiEl?.value.trim() || ''
                    },
                    popup: {
                        position: positionEl?.value || 'top-right',
                        soundEnabled: soundEnabledEl?.checked !== false,
                        maxPopups: Math.max(1, Math.min(8, parseInt(maxPopupsEl?.value) || 4)),
                        autoCloseDelay: autoCloseSeconds * 1000,
                        hideTransactionDetails: hideTransactionDetailsEl?.checked === true
                    },
                    supabase: {
                        url: supabaseUrlEl?.value.trim() || '',
                        key: supabaseKeyEl?.value.trim() || '',
                        enabled: supabaseEnabledEl?.checked === true
                    }
                };

                console.log('Saving config:', newConfig);
                const saved = await ipcRenderer.invoke('save-config', newConfig);

                if (saved) {
                    currentConfig = { ...currentConfig, ...newConfig };
                    const supabaseStatus = newConfig.supabase.enabled ? 'B·∫¨T (t·ª± ƒë·ªông l∆∞u giao d·ªãch)' : 'T·∫ÆT (ch·ªâ xem d·ªØ li·ªáu c√≥ s·∫µn)';
                    showMessage(`‚úÖ C·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!\nüíæ Supabase: ${supabaseStatus}`, 'success');

                    // Reinitialize Supabase client with new settings
                    initializeSupabase();

                    // Always reload transactions to reflect current state
                    await loadTransactions();

                    // Update status
                    await updateStatus();
                } else {
                    showMessage('‚ùå L·ªói khi l∆∞u c·∫•u h√¨nh! Vui l√≤ng ki·ªÉm tra quy·ªÅn ghi file.', 'error');
                }
            } catch (error) {
                console.error('Config save error:', error);
                showMessage('‚ùå L·ªói: ' + error.message, 'error');
            }
        }
        async function testPushbulletConnection() {
            const pushbulletApiEl = document.getElementById('pushbulletApi');
            const apiKey = pushbulletApiEl?.value.trim() || '';
            if (!apiKey) {
                showMessage('‚ùå Vui l√≤ng nh·∫≠p Pushbullet API key', 'error');
                return;
            }

            try {
                showMessage('üîÑ ƒêang test k·∫øt n·ªëi Pushbullet...', 'info');
                const result = await ipcRenderer.invoke('test-pushbullet', apiKey);

                if (result.success) {
                    showMessage('‚úÖ K·∫øt n·ªëi Pushbullet th√†nh c√¥ng!', 'success');
                } else {
                    showMessage('‚ùå L·ªói k·∫øt n·ªëi Pushbullet: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå L·ªói test Pushbullet: ' + error.message, 'error');
            }
        }

        async function testSupabaseConnection() {
            const supabaseUrlEl = document.getElementById('supabaseUrl');
            const supabaseKeyEl = document.getElementById('supabaseKey');
            const url = supabaseUrlEl?.value.trim() || '';
            const key = supabaseKeyEl?.value.trim() || '';

            if (!url || !key) {
                showMessage('‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Supabase URL v√† Key', 'error');
                return;
            }

            try {
                showMessage('üîÑ ƒêang test k·∫øt n·ªëi Supabase...', 'info');
                const result = await ipcRenderer.invoke('test-supabase', url, key);

                if (result.success) {
                    showMessage('‚úÖ K·∫øt n·ªëi Supabase th√†nh c√¥ng!', 'success');
                } else {
                    showMessage('‚ùå L·ªói k·∫øt n·ªëi Supabase: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå L·ªói test Supabase: ' + error.message, 'error');
            }
        }

        async function testViettinSMS() {
            const samples = await ipcRenderer.invoke('get-sample-sms');
            const smsData = await ipcRenderer.invoke('parse-sms', samples.vietinbank, 'VietinBank');
            await ipcRenderer.invoke('show-popup', smsData);
            showMessage('üì± Hi·ªÉn th·ªã popup VietinBank', 'info');
        }

        async function testVietcombankSMS() {
            const samples = await ipcRenderer.invoke('get-sample-sms');
            const smsData = await ipcRenderer.invoke('parse-sms', samples.vietcombank, 'Vietcombank');
            await ipcRenderer.invoke('show-popup', smsData);
            showMessage('üì± Hi·ªÉn th·ªã popup Vietcombank', 'info');
        }

        async function testMultiplePopups() {
            try {
                const result = await ipcRenderer.invoke('test-multiple-popups');
                if (result.success) {
                    showMessage(`üì± Hi·ªÉn th·ªã ${result.count} popup li√™n ti·∫øp`, 'info');
                } else {
                    showMessage('‚ùå L·ªói hi·ªÉn th·ªã popup', 'error');
                }
            } catch (error) {
                showMessage('‚ùå L·ªói hi·ªÉn th·ªã popup: ' + error.message, 'error');
            }
        }

        async function testCustomPopup() {
            const customSMS = {
                bank: 'vietinbank',
                sender: 'VietinBank',
                transactionType: 'credit',
                transactionAmount: 5000000,
                balance: 99999999,
                description: 'Test popup tuy chinh - Kiem tra hien thi',
                timestamp: Date.now(),
                isValid: true
            };

            try {
                await ipcRenderer.invoke('test-popup', customSMS);
                showMessage('üéØ Hi·ªÉn th·ªã popup t√πy ch·ªânh', 'info');
            } catch (error) {
                showMessage('‚ùå L·ªói hi·ªÉn th·ªã popup: ' + error.message, 'error');
            }
        }

        async function closeAllPopups() {
            await ipcRenderer.invoke('close-all-popups');
            showMessage('üóëÔ∏è ƒê√£ ƒë√≥ng t·∫•t c·∫£ popup', 'info');
        }

        async function loadTransactions() {
            const listEl = document.getElementById('transactionHistory');

            if (!listEl) {
                console.warn('Transaction history element not found');
                return;
            }

            if (!supabaseClient) {
                listEl.innerHTML = '<div class="no-data">‚ö†Ô∏è Supabase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh</div>';
                // Hide balance summary when no Supabase client
                const balanceSummaryEl = document.getElementById('balanceSummary');
                if (balanceSummaryEl) balanceSummaryEl.style.display = 'none';
                return;
            }

            // Always load transactions if Supabase is configured, regardless of enabled status
            // This allows users to view transaction history even when auto-save is disabled
            listEl.innerHTML = '<div class="loading">üîÑ ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            try {
                const { data, error } = await supabaseClient
                    .from('banking_transactions')
                    .select('*')
                    .order('received_at', { ascending: false })
                    .limit(50);

                if (error) {
                    throw error;
                }

                if (!data || data.length === 0) {
                    const statusMessage = currentConfig.supabase?.enabled
                        ? 'üì≠ Ch∆∞a c√≥ giao d·ªãch n√†o (Supabase ƒëang b·∫≠t - giao d·ªãch m·ªõi s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông)'
                        : 'üì≠ Ch∆∞a c√≥ giao d·ªãch n√†o (Supabase ƒë√£ t·∫Øt - ch·ªâ xem d·ªØ li·ªáu c√≥ s·∫µn)';
                    listEl.innerHTML = `<div class="no-data">${statusMessage}</div>`;
                    // Hide balance summary when no transactions
                    const balanceSummaryEl = document.getElementById('balanceSummary');
                    if (balanceSummaryEl) balanceSummaryEl.style.display = 'none';
                    return;
                }

                renderTransactions(data);
                calculateBalanceSummary(data);

                const statusMessage = currentConfig.supabase?.enabled
                    ? `‚úÖ ƒê√£ t·∫£i ${data.length} giao d·ªãch (Supabase: B·∫¨T - t·ª± ƒë·ªông l∆∞u)`
                    : `‚úÖ ƒê√£ t·∫£i ${data.length} giao d·ªãch (Supabase: T·∫ÆT - ch·ªâ xem)`;
                // showMessage(statusMessage, 'success');

            } catch (error) {
                console.error('Error loading transactions:', error);

                // Provide more specific error messages
                let errorMessage = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
                if (error.message.includes('relation') && error.message.includes('does not exist')) {
                    errorMessage = 'B·∫£ng banking_transactions ch∆∞a t·ªìn t·∫°i. Vui l√≤ng t·∫°o b·∫£ng theo schema.';
                } else if (error.message.includes('JWT') || error.message.includes('authentication')) {
                    errorMessage = 'L·ªói x√°c th·ª±c. Vui l√≤ng ki·ªÉm tra Supabase Key.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra internet.';
                } else {
                    errorMessage = error.message;
                }

                listEl.innerHTML = `<div class="no-data">‚ùå ${errorMessage}</div>`;
                // Hide balance summary when error
                const balanceSummaryEl = document.getElementById('balanceSummary');
                if (balanceSummaryEl) balanceSummaryEl.style.display = 'none';
                showMessage(`‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Supabase: ${errorMessage}`, 'error');
            }
        }

        function renderTransactions(transactions) {
            const listEl = document.getElementById('transactionHistory');

            if (!transactions || transactions.length === 0) {
                listEl.innerHTML = '<div class="no-data">üì≠ Ch∆∞a c√≥ giao d·ªãch n√†o</div>';
                // Hide balance summary when no transactions
                const balanceSummaryEl = document.getElementById('balanceSummary');
                if (balanceSummaryEl) balanceSummaryEl.style.display = 'none';
                return;
            }

            const tableRows = transactions.map(transaction => {
                const isIncoming = transaction.transaction_type === 'incoming';
                const amountClass = isIncoming ? 'incoming' : 'outgoing';
                const amountSign = isIncoming ? '+' : '-';

                return `
                    <tr>
                        <td class="transaction-time">${formatDateTime(transaction.received_at)}</td>
                        <td class="transaction-bank">${transaction.bank || 'Unknown'}</td>
                        <td class="transaction-amount ${amountClass}">
                            ${amountSign}${formatCurrency(transaction.amount)}
                        </td>
                        <td class="transaction-balance">${formatCurrency(transaction.balance)}</td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>T√™n Bank</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>SD cu·ªëi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;

            listEl.innerHTML = tableHtml;
        }

        function calculateBalanceSummary(transactions) {
            const balanceSummaryEl = document.getElementById('balanceSummary');

            if (!transactions || transactions.length === 0) {
                if (balanceSummaryEl) balanceSummaryEl.style.display = 'none';
                // Update tray menu with zero balances
                ipcRenderer.invoke('update-balance', 0, 0);
                return;
            }

            // Sort transactions by received_at descending to get latest first
            const sortedTransactions = [...transactions].sort((a, b) =>
                new Date(b.received_at) - new Date(a.received_at)
            );

            // Get latest balance for each bank (record cu·ªëi c√πng c·ªßa ng√¢n h√†ng)
            const latestBalances = {};

            sortedTransactions.forEach(transaction => {
                const bank = transaction.bank?.toLowerCase() || 'other';
                // Only take the first (latest) transaction for each bank
                if (!latestBalances[bank] && transaction.balance != null) {
                    latestBalances[bank] = parseFloat(transaction.balance) || 0;
                }
            });

            // Get balances for main banks
            const vietcombankBalance = latestBalances['vietcombank'] || 0;
            const vietinBalance = latestBalances['vietinbank'] || 0;

            // Calculate total
            const totalBalance = vietcombankBalance + vietinBalance;

            // Update UI elements
            const vietcombankEl = document.getElementById('vietcombankBalance');
            const vietinEl = document.getElementById('vietinBalance');
            const totalEl = document.getElementById('totalBalance');

            if (vietcombankEl) vietcombankEl.textContent = formatCurrency(vietcombankBalance) + ' VND';
            if (vietinEl) vietinEl.textContent = formatCurrency(vietinBalance) + ' VND';
            if (totalEl) totalEl.textContent = formatCurrency(totalBalance) + ' VND';

            // Show summary if we have any balance data
            if (balanceSummaryEl) {
                if (vietcombankBalance > 0 || vietinBalance > 0) {
                    balanceSummaryEl.style.display = 'block';
                } else {
                    balanceSummaryEl.style.display = 'none';
                }
            }

            // Update tray menu with balance data
            ipcRenderer.invoke('update-balance', vietcombankBalance, vietinBalance);

            // Log for debugging
            console.log('Balance Summary:', {
                vietcombank: vietcombankBalance,
                vietinbank: vietinBalance,
                total: totalBalance,
                latestBalances: latestBalances
            });
        }

        function formatCurrency(amount) {
            if (!amount) return '0';
            return new Intl.NumberFormat('vi-VN').format(amount);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '--:--';

            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) return '--:--';

                return date.toLocaleString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return '--:--';
            }
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.className = `message ${type}`;
                messageEl.style.display = 'block';

                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);
            } else {
                // Fallback to console if message element doesn't exist
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }

        // Listen for SMS received
        ipcRenderer.on('sms-received', (event, smsData) => {
            let message = `üí∞ ${smsData.bank.toUpperCase()}: ${smsData.transactionAmount} VND`;

            if (smsData.supabaseEnabled) {
                if (smsData.supabaseSaved) {
                    message += ' ‚úÖ ƒê√£ l∆∞u DB';
                    // Reload transactions to show new data
                    setTimeout(() => loadTransactions(), 1000);
                } else {
                    message += ' ‚ùå L·ªói l∆∞u DB';
                }
            }

            showMessage(message, 'success');
        });

        // Listen for window focus to reload transactions
        window.addEventListener('focus', () => {
            if (currentConfig.supabase?.enabled && supabaseClient) {
                loadTransactions();
            }
        });

        // Listen for window opened from tray
        ipcRenderer.on('window-opened', () => {
            if (currentConfig.supabase?.enabled && supabaseClient) {
                loadTransactions();
            }
        });

        // Update status periodically
        setInterval(updateStatus, 5000);

        // Additional functions for Office-style interface
        async function startServices() {
            try {
                await ipcRenderer.invoke('start-services');
                showMessage('Services started', 'success');
                await updateStatus();
            } catch (error) {
                showMessage('Failed to start services: ' + error.message, 'error');
            }
        }

        async function stopServices() {
            try {
                await ipcRenderer.invoke('stop-services');
                showMessage('Services stopped', 'info');
                await updateStatus();
            } catch (error) {
                showMessage('Failed to stop services: ' + error.message, 'error');
            }
        }

        function clearTransactionHistory() {
            const historyEl = document.getElementById('transactionHistory');
            if (historyEl) {
                historyEl.innerHTML = '<div class="no-data">Transaction history cleared</div>';
            }
        }

        // Alias for loadTransactions to match button onclick
        function loadTransactionHistory() {
            loadTransactions();
        }

        // Window control functions - Modified to hide window instead of closing app
        function closeWindow() {
            ipcRenderer.send('hide-window');
        }

        // Dropdown menu functionality
        function toggleDropdown(menuId) {
            // Close all other dropdowns first
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            allDropdowns.forEach(dropdown => {
                if (dropdown.id !== menuId) {
                    dropdown.classList.remove('show');
                }
            });

            // Toggle the clicked dropdown
            const dropdown = document.getElementById(menuId);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.menu-item')) {
                const allDropdowns = document.querySelectorAll('.dropdown-menu');
                allDropdowns.forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Prevent dropdown from closing when clicking on dropdown items
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('dropdown-item')) {
                // Close the dropdown after clicking an item
                setTimeout(() => {
                    const allDropdowns = document.querySelectorAll('.dropdown-menu');
                    allDropdowns.forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                }, 100);
            }
        });
    </script>
</body>

</html>